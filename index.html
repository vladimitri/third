<html>
<head>
    <style type="text/css">
        .img{
            width:150px;
            height:100px;
        }
    </style>
    <script src="/jquery-3.1.0.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {

            var hideAll = function(){
                $('div').hide();
            }

            var showIndex = function(){
                hideAll();

                showLoading();
                refreshIndexTable(function(){
                    $('.notlogged').show();
                    $('.cart').show();
                    $('.loading').hide();
                    $('.indexPage').show();
                });

            }

            var showLogin = function(){
                hideAll();
                $('.loginD').show();
            }

            var showCart = function(){
                hideAll();
                showLoading();
                refreshCartTable(function(){
                    $('.loading').hide();
                    $('.cartPage').show();
                });
            }




            var showLoading = function(){
                $('div').hide();
                $('.loading').show();
            }

            var refreshCartTable = function(callback){
                $.ajax('/main/cart',{
                    data:'get',
                    dataType:'json',
                    success : function(result){
                        if(!result || !result.success ||!result.data){
                            alert(result && !result.success ? result.message :'eroare');
                        } else {
                            $('.cartRow').remove();
                            var html ='';
                            console.log(result);
                            $.each(result.data ,function(index,value){
                                console.log(value.title);
                                html+=  '<tr class="cartRow">'+
                                            '<td>' + '<img src="uploads/'+value.id + value.image+'" class="img">' + '</td>'+
                                            '<td>'+value.title +'</td>' +
                                            '<td>'+value.price+'</td>'+
                                            '<td>'+result.quantity[value.id]+'</td>'+
                                        '</tr>'
                            });
                            console.log(" xxx");
                            $('.cartTable').append(html);
                        }
                        if(callback){
                            callback();
                        }


                    },
                    error : function (){
                        //alert('crashed');
                    }
                });
            }


            var refreshIndexTable = function(callback){
                $.ajax('/main/getproducts',{
                    type : 'get' ,
                    dataType : 'Json' ,
                    success : function(result){
                        if(!result || !result.success || !result.data){
                            alert('Error');
                        } else {
//                            $('.indexTable').remove();
                            $('.indexRow').remove();
                            var html = '';
                            $.each(result.data,function(index,value){
                                html += ' <tr class="indexRow"> ' +
                                            '<td>' + '<img src="uploads/'+value.id + value.image+'" class="img">' + '</td>' +
                                            '<td>' + value.title + '</td>' +
                                            '<td>' + value.price + '</td>' +
                                            '<td>' + value.description + '</td>' +
                                            '<td>'+'<a href="#addtocart/id/'+value.id+'">Add to cart</a>'+'</td>'
                                        '</tr>'
                            });
                            $('.indexTable').append(html);
                            if(callback){
                                callback();
                            }
                        }

                    },
                    error : function(){
                        alert('error');
                    }
                });
            }


            var hashChange = function(){

                switch(window.location.hash){
                    case '' :window.location.hash='#index' ;break;
                    case '#index' : showIndex(); break;
                    case '#login' : showLogin();break;
                    case '#cart' : showCart();break;
                    default :
                        if(window.location.hash.indexOf('#addtocart/id/')==0){
                            hideAll();
                            var elements = window.location.hash.split('/');
                            var id = elements[2];
                            $.ajax('/main/addtocart',{
                                type : 'get' ,
                                dataType : 'json',
                                data :{
                                    id : id
                                },
                                success: function(result){
                                    if(!result || !result.success){
                                        alert(result && !result.success ? result.message : 'Error')
                                    } else {
                                        window.location.hash='#index';
                                        showIndex();
                                    }
                                },
                                error : function (result){
                                    console.log(result);
                                    console.log(1);
                                }
                            });
                        }

                        ;break
                }

            }

            $(window).on('hashchange', hashChange);

            hashChange();


        });
    </script>
</head>
<body>
    <div class="loading">Loading...</div>


    <div class="indexPage">

        <div class="notlogged">
            <a href="#login">Login</a>
        </div>

        <div class="logged">Logged as :</div>

        <div class="logged">
            <a href="#logout">Logout</a>
        </div>

        <div class="logged">
            <a href="#edit">Edit</a>
        </div>

        <div class="cart"><a href="#cart">Cart</a></div>

        Produse:
        <table class="indexTable">
            <tr>
                <th>Imagine</th>
                <th>Nume produs</th>
                <th>Price</th>
                <th>Descriere</th>
            </tr>
        </table>
    </div>

    <div class="cartPage">
        <a href="#index" >Home</a><br/>
        Incart:
        <table class="cartTable">
            <tr>
                <th>Imagine</th>
                <th>Nume produs</th>
                <th>Price</th>
                <th>Cantitate</th>
            </tr>
        </table>
    </div>

    <div class="loginD">
        <form class="loginForm">
            Username:<input type="text" name="userid"><br />
            Password:<input type="password" name="password"><br />
            <input type="submit" name="check" value="login">
            <a href="#index" >Home</a>
        </form>
    </div>

    <div class="editD">
        <form class="editForm">
            Title:<input type="text" name="prodTitle"><br/>
            Price:<input type="number" name="prodPrice"><br/>
            Description:<textarea rows="4" cols="50" name="prodDescription"></textarea><br/>
            Image:<input type="text" name="image"><br/>
            <input type="submit" value="Save"><br/>
        </form>
    </div>
</body>
</html>
