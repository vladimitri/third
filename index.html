<html>
<head>
    <style type="text/css">
        .img{
            width:150px;
            height:100px;
        }
    </style>
    <script src="/jquery-3.1.0.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {

            var hideAll = function(){
                $('div').hide();
            }

            function checklogin (){
                $.ajax('/main/checklogin',{
                    type :'get',
                    dataType :'json',
                    success: function(result){
                        if(!result || !result.success ){
                            $('.idlabel').remove();
                            $('.logged').hide();
                            $('.notlogged').show();
                        } else {
                            $('#loggedlabel').append('<div class="idlabel">'+result.userid+'</div>');
                            $('.logged').show();
                            $('.notlogged').hide();
                        }
                    },
                    error : function(){
                        alert('crashed');
                    }
                });

            }

            function checkloginAsync (){
                var x = $.ajax('/main/checklogin',{
                    type :'get',
                    dataType :'json',
                    async : false ,
                    success: function(result){
                        if(!result || !result.success ){
                            $('.idlabel').remove();
                            $('.logged').hide();
                            $('.notlogged').show();
                        } else {
                            $('#loggedlabel').append('<div class="idlabel">'+result.userid+'</div>');
                            $('.logged').show();
                            $('.notlogged').hide();
                        }
                    },
                    error : function(){
                        alert('crashed');
                    }
                });
                return JSON.parse(x.responseText).success;
            }

            var showIndex = function(){
                hideAll();

                showLoading();
                refreshIndexTable(function(){
                    checklogin();
                    $('.cart').show();
                    $('.loading').hide();
                    $('.indexPage').show();
                    $('.editbuttons').hide();
                    $('.indexbuttons').show();
                });
            }

            var showEditMode = function(){
                hideAll();
                showLoading();
                if(checkloginAsync() == true){
                    refreshIndexTable(function(){
                        $('.loading').hide();
                        $('.add').show();
                        $('.indexPage').show();
                        $('.home').show();
                        $('#edit').hide();
                        $('#logout').hide();
                        $('.editbuttons').show();
                        $('.indexbuttons').hide();
                    });
                } else {
                    window.location.hash = '#index';
                }
            }
            var showEmptyCart = function (){
                hideAll();
                $('.cartPage').hide();
                $('.emptycart').show();
            }

            var showLogin = function(){
                hideAll();
                $('.loginD').show();
            }

            var showCart = function(){
                hideAll();
                showLoading();
                refreshCartTable(function(){
                    $('.loading').hide();
                    $('.cartPage').show();
                });
            }

            var showLoading = function(){
                $('div').hide();
                $('.loading').show();
            }

            var hideLoading = function(){
                $('.loading').hide();
            }

            var refreshCartTable = function(callback){
                $.ajax('/main/cart',{
                    data:'get',
                    dataType:'json',
                    success : function(result){
                        if(!result || !result.success ||!result.data){
                            alert(result && !result.success ? result.message :'eroare');
                        } else {
                            $('.cartRow').remove();
                            $('.cartTotal').remove();
                            var total=0;
                            var html ='';
                            if(result.data.length!=0) {
                                $.each(result.data, function (index, value) {
                                    total += value.price * result.quantity[value.id];
                                    html += '<tr class="cartRow">' +
                                            '<td>' + '<img src="uploads/' + value.id + value.image + '" class="img">' + '</td>' +
                                            '<td>' + value.title + '</td>' +
                                            '<td>' + value.price + '</td>' +
                                            '<td>' + result.quantity[value.id] + '</td>' +
                                            '<td>' + '<a href="#removefromcart/id/' + value.id + '">Remove from cart</a>' + '</td>'
                                    '</tr>';
                                });
                                $('.cartTable').append(html);
                                $('.cartTable').append('<p class="cartTotal">Total price :' + total + '</p>');
                                $('.cartTable').append('<a class="cartTotal" href="#buy">Buy</a>');
                                if(callback){
                                    callback();
                                }
                            } else {
                                if(callback){
                                    callback();
                                }
                                showEmptyCart();
                            }
                        }

                    },
                    error : function (){
                        //alert('crashed');
                    }
                });
            }
            var refreshIndexTable = function(callback){
                $.ajax('/main/getproducts',{
                    type : 'get' ,
                    dataType : 'Json' ,
                    success : function(result){
                        if(!result || !result.success || !result.data){
                            alert('Error');
                        } else {
//                            $('.indexTable').remove();
                            $('.indexRow').remove();
                            var html = '';
                            $.each(result.data,function(index,value){
                                html += ' <tr class="indexRow"> ' +
                                            '<td>' + '<img src="uploads/'+value.id + value.image+'" class="img">' + '</td>' +
                                            '<td>' + value.title + '</td>' +
                                            '<td>' + value.price + '</td>' +
                                            '<td>' + value.description + '</td>' +
                                            '<td>'+
                                                '<a  class="editbuttons" href="#edit/id/'+value.id+'">Edit</a>'+ ' ' +
                                                '<a  class="editbuttons" href="#remove/id/'+value.id+'">Remove</a>'+ ' ' +
                                                '<a  class="indexbuttons" href="#addtocart/id/'+value.id+'">Add to cart</a>'+
                                            '</td>'
                                        '</tr>'
                            });
                            $('.indexTable').append(html);
                            if(callback){
                                callback();
                            }
                        }
                    },
                    error : function(){
                        alert('error');
                    }
                });
            }

            var logout = function(){
                $.ajax('/main/logout',{
                    type : 'get' ,
                    dataType :'json' ,
                    success : function (result){
                        if(!result || !result.success){
                            alert(result && !result.success ? 'cant logout' : 'logout error');
                        } else {
                            window.location.hash = '#index';
                        }
                    },
                    error : function(){
                        alert('crashed');
                    }
                })
            }

            var addProduct = function(){
                hideAll();
                showLoading();
                if(checkloginAsync() == true) {
                    hideLoading();
                    $('.addD').show();
                } else {
                    window.location.hash = '#index';
                }
            }

            $('.loginForm').submit(function(event){
                event.preventDefault();
                $.ajax('/main/login',{
                    type :'post',
                    dataType :'json',
                    data : $('.loginForm').serialize(),
                    success :function(result){
                        if(!result || !result.success ){
                            alert(result && !result.success ? 'wrong login' : 'login error');
                        } else {
                            window.location.hash='#index';
                        }
                    },
                    error : function(){
                        alert ('crashed');
                    }
                })
            });

            $('.addForm').submit(function(event){
                event.preventDefault();
                $.ajax('/main/add',{
                    type : 'get' ,
                    dataType :'Json' ,
                    data : $('.addForm').serialize(),
                    success : function(result){
                        if(!result ||!result.success){
                            alert(result && !result.success ? 'not added' : 'error')
                        } else {
                            window.location.hash = '#edit';
                        }
                    } ,
                    error : function(){
                        alert('crashed');
                    }
                });
            });

            var hashChange = function(){

                switch(window.location.hash){
                    case '' :window.location.hash='#index' ;break;
                    case '#index' : showIndex(); break;
                    case '#login' : showLogin();break;
                    case '#cart' : showCart();break;
                    case '#logout':logout();break;
                    case '#edit':showEditMode();break;
                    case '#add':addProduct();break;
                    default :
                        if(window.location.hash.indexOf('#addtocart/id/')==0){
                            hideAll();
                            var elements = window.location.hash.split('/');
                            var id = elements[2];
                            $.ajax('/main/addtocart',{
                                type : 'get' ,
                                dataType : 'json',
                                data :{
                                    id : id
                                },
                                success: function(result){
                                    if(!result || !result.success){
                                        alert(result && !result.success ? result.message : 'Error')
                                    } else {
                                        window.location.hash='#index';

                                    }
                                },
                                error : function (result){
                                    alert('error');
                                }
                            });
                        } else if(window.location.hash.indexOf('#removefromcart/id/')==0){
                            hideAll();
                            var elements = window.location.hash.split('/');
                            var id = elements[2];
                            $.ajax('/main/removefromcart',{
                                type : 'get' ,
                                dataType :'json',
                                data :{
                                    id : id
                                },
                                success : function(result){
                                    if(!result || !result.success){
                                        alert (result && !result.success ? 'didnt work' : 'error');
                                    } else {
                                        window.location.hash='#cart';
                                        showCart();
                                    }
                                },
                                error : function(){
                                    alert('crashed');
                                }
                            });
                        } else if(window.location.hash.indexOf('#remove/id/')==0){
                            showLoading();
                            if(checkloginAsync()){
                                hideAll();
                                var elements = window.location.hash.split('/');
                                var id = elements[2];
                                $.ajax('/main/remove',{
                                    type : 'get' ,
                                    dataType :'json',
                                    data :{
                                        id : id
                                    },
                                    success : function(result){
                                        if(!result || !result.success){
                                            alert (result && !result.success ? 'didnt work' : 'error');
                                        } else {
                                            window.location.hash='#edit';
                                        }
                                    },
                                    error : function(){
                                        alert('crashed');
                                    }
                                });
                                hideLoading();
                            } else {
                                hideLoading();
                                window.location.hash = '#index';
                            }
                        }
                        ;break
                }

            }
            $(window).on('hashchange', hashChange);
            hashChange();
        });
    </script>
</head>
<body>
    <div class="loading">Loading...</div>


    <div class="indexPage">

        <div class="notlogged" id="login">
            <a href="#login">Login</a>
        </div>

        <div class="home"><a href="#index">Home</a></div>

        <div class="logged" id="loggedlabel">Logged as :</div>

        <div class="logged" id="logout">
            <a href="#logout">Logout</a>
        </div>

        <div class="logged" id="edit">
            <a href="#edit">Edit</a>
        </div>

        <div class="cart"><a href="#cart">Cart</a></div>

        <div class="add"><a href="#add">Add</a></div>

        Produse:
        <table class="indexTable">
            <tr>
                <th>Imagine</th>
                <th>Nume produs</th>
                <th>Price</th>
                <th>Descriere</th>
            </tr>
        </table>
    </div>

    <div class="emptycart">
        The cart is empty
        <a href="#index">Home</a>
    </div>

    <div class="cartPage">
        <a href="#index" >Home</a><br/>
        Incart:
        <table class="cartTable">
            <tr>
                <th>Imagine</th>
                <th>Nume produs</th>
                <th>Price</th>
                <th>Cantitate</th>
            </tr>
        </table>
    </div>

    <div class="loginD">
        <form class="loginForm">
            Username:<input type="text" name="userid"><br />
            Password:<input type="password" name="password"><br />
            <input type="submit" name="check" value="login">
            <a href="#index" >Home</a>
        </form>
    </div>

    <div class="addD">
        <form class="addForm">
            Title:<input type="text" name="prodTitle"><br/>
            Price:<input type="number" name="prodPrice"><br/>
            Description:<textarea rows="4" cols="50" name="prodDescription"></textarea><br/>
            Image:<input type="text" name="prodImage"><br/>
            <input type="submit" value="Save"><br/>
            <a href="#edit" >Go back</a>
        </form>
    </div>
</body>
</html>
